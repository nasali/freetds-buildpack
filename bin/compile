#!/usr/bin/env ruby
require 'mkmf'
puts "-----> Found a .freetds.conf"

# sync output
$stdout.sync = true

S3BUCKET="https://s3.amazonaws.com/chameleon-heroku-assets"
FREETDS_TGZ="#{S3BUCKET}/freetds-openssl.tar.gz"
OPENSSL_TGZ="#{S3BUCKET}/openssl-1.0.1e.tar.gz"
VENDOR_DIR="#{ARGV[0]}/vendor"
FREETDS_DIR="#{VENDOR_DIR}/freetds"
OPENSSL_DIR="#{VENDOR_DIR}/openssl"

def indent msg 
  puts "       #{msg}"
end

indent "Creating folders"
result = `mkdir #{FREETDS_DIR} #{OPENSSL_DIR}`

indent "Downloading and extracting archives from #{S3BUCKET}..."
result = `curl #{FREETDS_TGZ} -s -o - | tar -xz -C #{FREETDS_DIR} -f - `

raise "ERROR! #{$?}" unless $?.success?

result = `curl #{OPENSSL_TGZ} -s -o - | tar -xz -C #{OPENSSL_DIR} -f - `

if $?.success?
  indent "Done."
else
  raise "ERROR! #{$?}"
end
