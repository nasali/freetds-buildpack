#!/usr/bin/env ruby
require 'mkmf'
puts "-----> Found a .freetds.conf"

# sync output
$stdout.sync = true

S3BUCKET="https://s3.amazonaws.com/chameleon-heroku-assets"
FREETDS_TGZ="#{S3BUCKET}/freetds.tar.gz"
VENDOR_DIR="#{ARGV[0]}/vendor"
FREETDS_DIR="#{VENDOR_DIR}/freetds"
TINYTDS_DIR="#{VENDOR_DIR}/bundle"

def indent msg 
  puts "       #{msg}"
end

indent "Creating folder"
resuult = `mkdir #{FREETDS_DIR}`

indent "Downloading and extracting archive from #{S3BUCKET}..."
result = `curl #{FREETDS_TGZ} -o - | tar -xz -C #{FREETDS_DIR} -f - `

if $?.success?  
  indent "Installing TinyTDS gem..."
  result = `mkdir #{TINYTDS_DIR} && gem install tiny_tds  -v 0.5.1 -i #{TINYTDS_DIR} -- --with-freetds-include=#{FREETDS_DIR}/include --with-freetds-lib=#{FREETDS_DIR}/lib `
  if $?.success?
    result = `mkdir #{VENDOR_DIR}/tinytds && cd #{VENDOR_DIR}/tinytds && gem unpack tiny_tds`
    puts `ls -alh #{VENDOR_DIR}/tinytds`
    indent "Done."
  else
    raise "ERROR! #{$?}"
  end
else
  raise "ERROR! #{$?}"
end
